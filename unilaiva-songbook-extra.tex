% This command will display some text followed by three dots,
% and aligned to the right of the page. The idea is to use it as a signal to go to
% a different part of the song, for example the chorus. You can use it within the
% last verse or between verses (in such a case it will be put on its own line).
\newcommand{\gotochorus}[1]{\hfill {\normalsize\textit{â†’ #1\ldots}}\par}

% This command will make a small horizontal space. Use this for example in the
% beginning of chorus lines, if you wish the chorus to stand out visually.
\newcommand{\chorusindent}{\hspace{1em}}

% Displays the parameter text centered in a large font. Use within songs, but outside
% verses. Intended to be used for short mantras for recitation.
\newcommand{\showmantra}[1]{{\vspace{1.5em}\begin{center}\Large #1\end{center}}\vspace{1.0em}}

% environment for 'song feeler'
\newenvironment{feeler}{
  \vspace{2em}
  \small
  \par\noindent\ignorespaces
  \begin{center}\begin{em}
}{
  \end{em}\end{center}
  %\par\noindent\ignorespacesafterend
}

% environment for 'song explanation'
\newenvironment{explanation}{
  \vspace{2em}
  \footnotesize
  \par\noindent\ignorespaces
}{
  \par\noindent\ignorespacesafterend
}

% environment for song translation, to be used inside a song
\newenvironment{translation}{
  \newcommand{\nextverse}{\medskip} % some vertical space between verses
  \beginverse*
  \chordsoff
  %\obeylines
  \vspace{1em}
  \small\textit
  %\par\noindent\ignorespaces
}{
  \endverse
  %\par\noindent\ignorespacesafterend
}

% BEGIN NOTE NAMES

% Call this from within a verse to disable note name hints in that verse
\newcommand{\notesoff}{\let\shownotes\undefined}

% This command displays an encircled note name hint. Must be called from within
% a chord definition like this \[\note{A}]. The parameter is the note name;
% note that it must be upper case for the transposing to work. Nevertheless,
% the note will be displayed in lower case in the result documnt. Call \notesoff
% command within a verse to disable showing of these notes for that verse.
% Define \newcommand{\showtaglist}{} in the main document to enable this feature.
\newcommand{\note}[1]{%
  % TODO: make accidentals font size smaller
  \ifdefined\shownotes%
    \notenamesout abcdefg%
    \hspace{-0.10em}\raisebox{0.3em}{\textmd{\color{notehintcolor}\normalsize\textcircled{\scriptsize\transposehere{#1}}}}%
  \fi%
}

% END NOTE NAMES

% BEGIN PRELUDE

% Support for AH song numbers. To show these numbers in song preludes,
% define \newcommand{\showahnumber}{} in the main document.
% To define this for a song, use ah={} parameter for \beginsong
\newcommand{\ahsongnumber}{}
\newsongkey{ah}{\def\ahsongnumber{}}
                {\def\ahsongnumber{AH: #1\par}}

% Support for extra song information. To show these in song preludes,
% define \newcommand{\showextrainfo}{} in the main document.
% To define this for a song, use ex={} parameter for \beginsong
\newcommand{\extrainfo}{}
\newsongkey{ex}{\def\extrainfo{}}
                {\def\extrainfo{#1\par}}

% BEGIN PRELUDE/TAGS.

% Support for tags for songs. To show them in song preludes,
% define \newcommand{\showtaglist}{} in the main document.
% Tags are defined as tags= keyval for \beginsong. An example:
% \beginsong{Songname}[tags={fire 1, water 1}. Note the weird
% syntax: the tagname must be followed by ' 1'. Valid tags are
% defined in file 'tags.can'.

\newcommand{\taglist}{}% defined below for each song

\makeatletter%

\newsongkey{tags}{\def\taglist{}\def\SB@rawrefs{}\gdef\songrefs{}}%
                 {\def\taglist{\StrSubstitute{#1}{ 1}{}\par}% Show only tag name, remove ' 1'
                  \def\SB@rawrefs{#1}\SB@parsesrefs{#1}}

\renewcommand\SB@makescripindex{%
  \renewenvironment{SB@lgidx}[1]{%
    \gdef\SB@idxcolhead{##1}%
    % Following three lines are commented out to skip the line used for book name
    %\hbox to\hsize{{\idxbook{##1}}\hfil}%
    %\nobreak%
    %\SB@idxheadsep\nointerlineskip%
  }{%
    \mark{\noexpand\relax}%
    \penalty-20\vskip3\p@\@plus3\p@\relax%
  }%
  \renewenvironment{SB@smidx}[1]
    {\begin{SB@lgidx}{##1}}{\end{SB@lgidx}}%
  \renewcommand\idxentry[2]{%
    \SB@ellipspread{\idxscripfont\relax\SB@idxcolhead}% ##1 -> SB@idxcolhead to display 'book name' instead of 'chapter number'
                   {{\idxrefsfont\relax##2}}%
    \SB@toks\expandafter{\SB@idxcolhead}%
    \mark{\noexpand\SB@idxcont{\the\SB@toks}}%
  }%
  \renewcommand\idxaltentry[2]{\SB@erridx{a scripture}}%
  \SB@displayindex%
}

\makeatother%

% END PRELUDE/TAGS


% Redefine displaying of song prelude. This version adds the new
% song keyvals introduced above. \showrefs is removed, because we
% use the scripture references as tags and they are displayed
% with \taglist.
\makeatletter%
\renewcommand{\extendprelude}{%
  \ifdefined\showtaglist%   following is similar to \showauthors
    {\setbox\SB@box\hbox{\hfill\sffamily\taglist}%
     \ifdim\wd\SB@box>\z@\unhbox\SB@box\par\vspace{-1em}\fi% Go up one line if tag list was non-empty
    }%
  \fi%
  \showauthors%
  \ifdefined\showextrainfo%
    {\sffamily\extrainfo}%
  \fi%
  \ifdefined\showahnumber%
    {\sffamily\ahsongnumber}%
  \fi%
}

% END PRELUDE

% The following rewrite of the \SB@@@beginsong command adds songs to the basic TOC also.
% Changes: lines between and including the first and last '\hypersetup' commands were added.
\makeatletter
\renewcommand\SB@@@beginsong{%
  \global\SB@stanzafalse%
  \setbox\SB@chorusbox\box\voidb@x%
  \SB@gotchorusfalse%
  \setbox\SB@songbox\vbox\bgroup\begingroup%
    \ifnum\SB@numcols>\z@\hsize\SB@colwidth\fi%
    \leftskip\z@skip\rightskip\z@skip%
    \parfillskip\@flushglue\parskip\z@skip%
    \SB@raggedright%
    \global\SB@transposefactor\z@%
    \global\SB@cr@{\\}%
    \protected@edef\@currentlabel{\p@songnum\thesongnum}%
    \setcounter{versenum}{1}%
    \SB@prevversetrue%
    \meter44%
    \resettitles%
    \SB@addtoindexes\songtitle\SB@rawrefs\songauthors%
    \nexttitle%
    \foreachtitle{\expandafter\SB@addtotitles\expandafter{\songtitle}}%
    \resettitles%
    \lyricfont\relax%
    \SB@setbaselineskip%
    \hypersetup{bookmarksdepth=0}%
    \phantomsection%
    \addcontentsline{toc}{subsection}{\numberline{\thesongnum}\songtitle}%
    \hypersetup{bookmarksdepth=2}%    
}

% The following rewrite adds only \color{mbarcolor} command to change the color of the measure bar
\renewcommand\SB@makembar[2]{%
  \ifSB@inverse\else%
    \ifSB@inchorus\else\SB@errmbar\fi%
  \fi%
  \ifhmode%
    \SB@skip\lastskip\unskip%
    \setbox\SB@box\lastbox%
    \copy\SB@box%
    \ifvbox\SB@box%
      \begingroup%
        \setbox\SB@boxii\copy\SB@box%
        \vbadness\@M\vfuzz\maxdimen%
        \setbox\SB@boxii%
          \vsplit\SB@boxii to\maxdimen%
      \endgroup%
      \long\edef\SB@temp{\splitfirstmark}%
      \ifx\SB@temp\SB@measuremark%
        \penalty100\hskip1em%
      \else%
        \penalty100\hskip\SB@skip%
      \fi%
    \else%
      \penalty100\hskip\SB@skip%
    \fi%
  \fi%
  \ifvmode\leavevmode\fi%
  \setbox\SB@box\hbox{{\meterfont\relax#1}}%
  \setbox\SB@boxii\hbox{{\meterfont\relax#2}}%
  \SB@dimen\wd\ifdim\wd\SB@box>\wd\SB@boxii\SB@box\else\SB@boxii\fi%
  \SB@dimenii\baselineskip%
  \advance\SB@dimenii-2\p@%
  \advance\SB@dimenii-\ht\SB@box%
  \advance\SB@dimenii-\dp\SB@box%
  \advance\SB@dimenii-\ht\SB@boxii%
  \advance\SB@dimenii-\dp\SB@boxii%
  \let\SB@temp\relax%
  \ifdim\SB@dimen>\z@%
    \advance\SB@dimenii-.75\p@%
    \def\SB@temp{\kern.75\p@}%
  \fi%
  \SB@maxmin\SB@dimen<{.5\p@}%
  \SB@maxmin\SB@dimenii<\z@%
  \vbox{%
    \mark{\SB@measuremark}%
    \hbox to\SB@dimen{%
      \hfil%
      \box\SB@box%
      \hfil%
    }%
    \nointerlineskip%
    \hbox to\SB@dimen{%
      \hfil%
      \box\SB@boxii%
      \hfil%
    }%
    \SB@temp%
    \nointerlineskip%
    \hbox to\SB@dimen{%
      \hfil%
      \color{mbarcolor}\vrule\@width.5\p@\@height\SB@dimenii%
      \hfil%
    }%
  }%
  \meter{}{}%
}
\let\SB@mbar\SB@makembar
\makeatother
